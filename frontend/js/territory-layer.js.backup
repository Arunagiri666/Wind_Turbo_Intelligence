// Territory Layer for Indian States
let dataLayer;
let hoveredStateId = null;

/**
 * Initialize territory layer
 */
async function initializeTerritoryLayer() {
    console.log('Initializing territory layer...');

    const map = getMap();
    if (!map) {
        console.error('Map not initialized');
        return;
    }

    // Create data layer
    dataLayer = new google.maps.Data();
    dataLayer.setMap(map);

    // Set default styles
    dataLayer.setStyle({
        fillColor: '#252B4A',
        fillOpacity: 0.2,
        strokeColor: '#4FC3F7',
        strokeWeight: 1.5,
        strokeOpacity: 0.6
    });

    // Load GeoJSON data for Indian states
    // Note: You'll need to provide actual GeoJSON files
    // For demo purposes, we'll add event listeners

    // Mouse over event
    dataLayer.addListener('mouseover', (event) => {
        hoveredStateId = event.feature.getId();
        dataLayer.overrideStyle(event.feature, {
            fillColor: '#00BCD4',
            fillOpacity: 0.4,
            strokeWeight: 2,
            strokeOpacity: 1
        });

        // Show state name
        const stateName = event.feature.getProperty('name');
        if (stateName) {
            console.log('Hovering over:', stateName);
        }
    });

    // Mouse out event
    dataLayer.addListener('mouseout', (event) => {
        dataLayer.revertStyle();
        hoveredStateId = null;
    });

    // Click event
    dataLayer.addListener('click', async (event) => {
        const stateName = event.feature.getProperty('name');
        const stateCode = event.feature.getProperty('code');

        console.log('State clicked:', stateName);

        if (stateName) {
            try {
                showLoading();
                const territoryData = await apiClient.getTerritoryByName(stateName);

                // Pan to state center
                if (territoryData.centerLatitude && territoryData.centerLongitude) {
                    panToLocation(territoryData.centerLatitude, territoryData.centerLongitude, 7);

                    // Fetch wind data for state center
                    const windData = await apiClient.getCurrentWindData(
                        territoryData.centerLatitude,
                        territoryData.centerLongitude
                    );

                    updateWindDataDisplay(windData);
                }

                hideLoading();
                showToast(`Viewing ${stateName}`);
            } catch (error) {
                console.error('Error loading state data:', error);
                hideLoading();
                showToast('Error loading state data', 'error');
            }
        }
    });

    // Try to load sample GeoJSON (you'll need to provide actual files)
    try {
        // This is a placeholder - you need to provide actual GeoJSON files
        // dataLayer.loadGeoJson('data/geojson/india-states.geojson');
        console.log('Territory layer initialized (GeoJSON loading pending)');
    } catch (error) {
        console.error('Error loading GeoJSON:', error);
    }
}

/**
 * Load GeoJSON for a specific state
 */
function loadStateGeoJSON(stateName, geoJsonUrl) {
    if (!dataLayer) {
        console.error('Data layer not initialized');
        return;
    }

    dataLayer.loadGeoJson(geoJsonUrl, null, (features) => {
        console.log(`Loaded ${features.length} features for ${stateName}`);
    });
}

/**
 * Highlight a specific state
 */
function highlightState(stateId) {
    if (!dataLayer) return;

    dataLayer.forEach((feature) => {
        if (feature.getId() === stateId) {
            dataLayer.overrideStyle(feature, {
                fillColor: '#FFD54F',
                fillOpacity: 0.5,
                strokeWeight: 2.5,
                strokeColor: '#FFA726'
            });
        }
    });
}

/**
 * Clear all state highlights
 */
function clearStateHighlights() {
    if (!dataLayer) return;
    dataLayer.revertStyle();
}

/**
 * Sample Indian states data (for demonstration)
 * In production, this should come from GeoJSON files
 */
const INDIAN_STATES = [
    { name: 'Tamil Nadu', code: 'TN', lat: 11.1271, lng: 78.6569 },
    { name: 'Gujarat', code: 'GJ', lat: 22.2587, lng: 71.1924 },
    { name: 'Rajasthan', code: 'RJ', lat: 27.0238, lng: 74.2179 },
    { name: 'Maharashtra', code: 'MH', lat: 19.7515, lng: 75.7139 },
    { name: 'Karnataka', code: 'KA', lat: 15.3173, lng: 75.7139 },
    { name: 'Andhra Pradesh', code: 'AP', lat: 15.9129, lng: 79.7400 },
    { name: 'Kerala', code: 'KL', lat: 10.8505, lng: 76.2711 },
    { name: 'Madhya Pradesh', code: 'MP', lat: 22.9734, lng: 78.6569 },
    { name: 'Uttar Pradesh', code: 'UP', lat: 26.8467, lng: 80.9462 },
    { name: 'West Bengal', code: 'WB', lat: 22.9868, lng: 87.8550 }
];
