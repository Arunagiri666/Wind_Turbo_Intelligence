// Google Maps Controller
let map;
let currentMarker;

const MAP_CONFIG = {
    center: { lat: 20.5937, lng: 78.9629 }, // Center of India
    zoom: 5,
    minZoom: 4,
    maxZoom: 18,
    styles: [
        {
            "featureType": "all",
            "elementType": "geometry",
            "stylers": [{ "color": "#0A0E27" }]
        },
        {
            "featureType": "all",
            "elementType": "labels.text.fill",
            "stylers": [{ "color": "#B0B8D4" }]
        },
        {
            "featureType": "all",
            "elementType": "labels.text.stroke",
            "stylers": [{ "color": "#0A0E27" }, { "weight": 2 }]
        },
        {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [{ "color": "#1A1F3A" }]
        },
        {
            "featureType": "landscape",
            "elementType": "geometry",
            "stylers": [{ "color": "#252B4A" }]
        },
        {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{ "color": "#38405F" }]
        },
        {
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [{ "color": "#2A3150" }]
        },
        {
            "featureType": "administrative",
            "elementType": "geometry.stroke",
            "stylers": [{ "color": "#4FC3F7" }, { "weight": 1 }]
        }
    ]
};

/**
 * Initialize Google Maps
 */
function initializeMap() {
    console.log('Initializing Google Maps...');

    map = new google.maps.Map(document.getElementById('map'), {
        center: MAP_CONFIG.center,
        zoom: MAP_CONFIG.zoom,
        minZoom: MAP_CONFIG.minZoom,
        maxZoom: MAP_CONFIG.maxZoom,
        styles: MAP_CONFIG.styles,
        disableDefaultUI: false,
        zoomControl: true,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: true,
        gestureHandling: 'greedy'
    });

    // Add click listener for map
    map.addListener('click', async (event) => {
        const lat = event.latLng.lat();
        const lon = event.latLng.lng();

        console.log('Map clicked at:', lat, lon);
        await handleMapClick(lat, lon);
    });

    console.log('Google Maps initialized successfully');
}

/**
 * Handle map click event
 */
async function handleMapClick(lat, lon) {
    try {
        // Show loading
        showLoading();

        // Remove previous marker
        if (currentMarker) {
            currentMarker.setMap(null);
        }

        // Add new marker
        currentMarker = new google.maps.Marker({
            position: { lat, lng: lon },
            map: map,
            animation: google.maps.Animation.DROP,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 10,
                fillColor: '#00BCD4',
                fillOpacity: 1,
                strokeColor: '#FFFFFF',
                strokeWeight: 2
            }
        });

        // Fetch wind data
        const windData = await apiClient.getCurrentWindData(lat, lon);

        // Update UI
        updateWindDataDisplay(windData);

        // Hide loading
        hideLoading();

        // Show success toast
        showToast('Wind data loaded successfully!');

    } catch (error) {
        console.error('Error handling map click:', error);
        hideLoading();
        showToast('Error loading wind data. Please try again.', 'error');
    }
}

/**
 * Pan map to location
 */
function panToLocation(lat, lon, zoom = 10) {
    map.panTo({ lat, lng: lon });
    map.setZoom(zoom);
}

/**
 * Add marker to map
 */
function addMarker(lat, lon, title = '') {
    if (currentMarker) {
        currentMarker.setMap(null);
    }

    currentMarker = new google.maps.Marker({
        position: { lat, lng: lon },
        map: map,
        title: title,
        animation: google.maps.Animation.DROP,
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#00BCD4',
            fillOpacity: 1,
            strokeColor: '#FFFFFF',
            strokeWeight: 2
        }
    });
}

/**
 * Get map instance
 */
function getMap() {
    return map;
}
